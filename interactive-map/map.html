<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Map - Community Emergency Hub</title>
    <link rel="stylesheet" href="styles.css">
    <!-- Include Leaflet CSS and JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
</head>

<body>
    <button class="menu-toggle" id="mobile-menu">
        <i class="fas fa-bars"></i>
    </button>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="logo">
                <h1>COMMUNITY<br>EMERGENCY HUB</h1>
            </div>

            <div class="tools">
                <h2>TOOLS</h2>
                <ul>
                    <li><a href="#" class="active"><i class="fas fa-map-marker-alt"></i> Interactive Map</a></li>
                    <li><a href="../first-aid/firstaid.html"><i class="fas fa-kit-medical"></i> First Aid Application</a></li>
                    <li><a href="../hotline/hotline.html"><i class="fas fa-phone"></i> Who to Call</a></li>
                    <li><a href="../"><i class="fas fa-home"></i> Homepage</a></li>
                </ul>
            </div>
        </aside>

        <main class="content">
            <div class="map-container">
                <div id="map"></div>
                <div class="info-panel" id="info-panel">
                    <button id="close-info" class="close-btn" onclick="closeInfoPanel()"><i class="fas fa-times"></i></button>
                    <h2>Location Information</h2>
                    <div id="info-content"></div>
                </div>
                <div id="imageModal" class="modal">
                    <span class="modal-close" onclick="closeModal()">&times;</span>
                    <img class="modal-content" id="modalImage">
                </div>
                <div class="map-controls">
                    <div class="dropdown">
                        <button class="map-btn dropdown-toggle"><i class="fas fa-layer-group"></i> Tools <i class="fas fa-chevron-down"></i></button>
                        <div class="dropdown-content">
                            <button class="map-btn" onclick="toggleFloodProne()"><i class="fas fa-water"></i> Flood-Prone Areas</button>
                            <button class="map-btn" onclick="toggleMedicalFacilities()"><i class="fas fa-clinic-medical"></i> Medical Facilities</button>
                            <button class="map-btn" onclick="toggleSchools()"><i class="fas fa-school"></i> Schools</button>
                            <button class="map-btn" onclick="toggleSportsVenues()"><i class="fas fa-basketball-ball"></i> Courts</button>
                            <button class="map-btn" onclick="toggleCommunityCenters()"><i class="fas fa-users"></i> Community Centers</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <script src="script.js"></script>

    <script>
        // Initialize the map centered on Valenzuela City
        const map = L.map('map', {
            zoomControl: false // Disable default zoom control to reposition it
        }).setView([14.675101722172926, 120.98265022929283],16);
        
        // Add zoom control to bottom right
        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        // Variables for tracking states
        let isInfoPanelOpen = false;
        let currentImageIndex = 0;
        let images = [];

        // Carousel and Modal Functions
        function moveCarousel(direction) {
            const track = document.querySelector('.carousel-track');
            const items = track.children.length;
            if (items === 0) return;

            currentImageIndex = (currentImageIndex + direction + items) % items;
            track.style.transform = `translateX(-${currentImageIndex * 100}%)`;
        }

        function openModal(imgSrc) {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            modal.style.display = 'block';
            modalImg.src = imgSrc;
            // Allow DOM to update before adding show class
            requestAnimationFrame(() => {
                modal.classList.add('show');
            });
        }

        function closeModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.remove('show');
            // Wait for transition to complete before hiding
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        }

        function updateCarousel(locationImages) {
            const track = document.querySelector('.carousel-track');
            track.innerHTML = '';
            currentImageIndex = 0;
            images = locationImages;

            locationImages.forEach((imgSrc, index) => {
                const item = document.createElement('div');
                item.className = 'carousel-item';
                const img = document.createElement('img');
                img.src = imgSrc;
                img.onclick = () => openModal(imgSrc);
                item.appendChild(img);
                track.appendChild(item);
            });

            track.style.transform = 'translateX(0)';
        }

        // Function to create a marker with popup and hover effect
        function createMarker(lat, lng, title, description, icon) {
            const marker = L.marker([lat, lng], {
                icon: icon
            });
        
            // Create a tooltip with the description
            marker.bindTooltip(`<div class="marker-tooltip"><h3>${title}</h3><p>${description}</p></div>`, {
                direction: 'auto',
                offset: L.point(0, -30),
                className: 'custom-tooltip',
                opacity: 0.9
            });
        
            // Show tooltip on hover
            marker.on('mouseover', function(e) {
                this.openTooltip();
            });
        
            // Hide tooltip when mouse leaves
            marker.on('mouseout', function(e) {
                this.closeTooltip();
            });
        
            // Function to show location info panel
            const showLocationInfo = () => {
                const infoPanel = document.getElementById('info-panel');
                const isCurrentlyOpen = infoPanel.style.right === '0px';
        
                // Toggle panel visibility based on screen size
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    infoPanel.style.bottom = isCurrentlyOpen ? '-100%' : '0';
                } else {
                    infoPanel.style.right = isCurrentlyOpen ? '-300px' : '0';
                }
                isInfoPanelOpen = !isCurrentlyOpen;
            };
        
            // Add click handler to marker
            marker.on('click', showLocationInfo);
        
            // Create label with click handler
            const label = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'map-label',
                    html: `<div class="clickable-label" style="cursor: pointer;">${title}</div>`,
                    iconSize: [200, 20],
                    iconAnchor: [100, 0]
                })
            }).on('click', showLocationInfo);
        
            return { marker, label };
        }

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        }).addTo(map);

        // Initialize dropdown functionality
        const dropdownToggle = document.querySelector('.dropdown-toggle');
        const dropdownContent = document.querySelector('.dropdown-content');

        dropdownToggle.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent event from bubbling up
            dropdownContent.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (event) => {
            if (!event.target.closest('.dropdown')) {
                dropdownContent.classList.remove('show');
            }
        });

        // Map control functions
        let evacuationMarkers = [];
        let floodOverlay = null;
        let facilityMarkers = [];
        let floodLabel = null;
        let isEvacuationVisible = false;
        let isFloodVisible = false;
        let isFacilitiesVisible = false;
        let medicalMarkers = [];
        let schoolMarkers = [];
        let sportsMarkers = [];
        let communityMarkers = [];
        let isMedicalVisible = false;
        let isSchoolsVisible = false;
        let isSportsVisible = false;
        let isCommunityVisible = false;


        function toggleFloodProne() {
            const button = document.querySelector('button[onclick="toggleFloodProne()"]');
            if (isFloodVisible) {
                // Remove existing overlay and label
                if (floodOverlay) {
                    floodOverlay.remove();
                    floodOverlay = null;
                }
                if (floodLabel) {
                    floodLabel.remove();
                    floodLabel = null;
                }
                isFloodVisible = false;
                button.classList.remove('active');
            button.style.backgroundColor = '';
            } else {
                // Define flood-prone area polygon
                const floodArea = [
                    [14.6780, 120.9720],
                    [14.6775, 120.9740],
                    [14.6760, 120.9745],
                    [14.6755, 120.9725],
                    [14.6780, 120.9720]
                ];

                // Add polygon overlay
                floodOverlay = L.polygon(floodArea, {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.3
                }).bindPopup('High-risk flood area').addTo(map);

                // Add label for flood area
                const floodCenter = [
                    (floodArea[0][0] + floodArea[2][0]) / 2,
                    (floodArea[0][1] + floodArea[2][1]) / 2
                ];
                floodLabel = L.marker(floodCenter, {
                    icon: L.divIcon({
                        className: 'map-label flood-label',
                        html: '<div>Flood-Prone Area</div>',
                        iconSize: [100, 20],
                        iconAnchor: [50, 0]
                    })
                }).addTo(map);
                isFloodVisible = true;
                button.classList.add('active');
            button.style.backgroundColor = '#FF4444';
            }
        }

        function toggleMedicalFacilities() {
            const button = document.querySelector('button[onclick="toggleMedicalFacilities()"]');
            if (isMedicalVisible) {
                medicalMarkers.forEach(marker => {
                    marker.marker.remove();
                    marker.label.remove();
                });
                medicalMarkers = [];
                isMedicalVisible = false;
                button.classList.remove('active');
            button.style.backgroundColor = '';
            } else {
                const facilities = [{
                    name: 'Fatima University Medical Center',
                    coords: [14.67797, 120.98095],
                    description: 'A comprehensive medical center offering 24/7 emergency services with modern facilities and experienced healthcare professionals.',
                    images: [
                        'assets/medical/fatima_1.svg',
                        'assets/medical/fatima_2.svg',
                        'assets/medical/fatima_3.svg'
                    ]
                }, {
                    name: 'E. Perlas Diagnostic and Polyclinic',
                    coords: [14.6810, 120.9785],
                    description: 'Specialized diagnostic center with state-of-the-art medical equipment and expert healthcare providers.',
                    images: [
                        'assets/medical/perlas_1.svg',
                        'assets/medical/perlas_2.svg',
                        'assets/medical/perlas_3.svg'
                    ]
                }, {
                    name: 'Calalang General Hospital',
                    coords: [14.67269, 120.98253],
                    description: 'Full-service general hospital providing emergency care, specialized treatments, and comprehensive medical services.',
                    images: [
                        'assets/medical/calalang_1.svg',
                        'assets/medical/calalang_2.svg',
                        'assets/medical/calalang_3.svg'
                    ]
                }];

                facilities.forEach(facility => {
                    const marker = L.marker(facility.coords)
                        .on('click', () => {
                            const infoPanel = document.getElementById('info-panel');
                            const isCurrentlyOpen = infoPanel.style.right === '0px';

                            document.getElementById('info-content').innerHTML = `
                                <h3>${facility.name}</h3>
                                <p><strong>Location:</strong> ${facility.coords[0].toFixed(4)}, ${facility.coords[1].toFixed(4)}</p>
                                <p>${facility.description}</p>
                                <div class="carousel-container">
                                    <div class="carousel-track">
                                        ${facility.images.map((imgSrc, index) => `
                                            <div class="carousel-item">
                                                <img src="${imgSrc}" onclick="openModal('${imgSrc}')" alt="${facility.name} Image ${index + 1}">
                                            </div>
                                        `).join('')}
                                    </div>
                                    <button class="carousel-btn prev" onclick="moveCarousel(-1)"><i class="fas fa-chevron-left"></i></button>
                                    <button class="carousel-btn next" onclick="moveCarousel(1)"><i class="fas fa-chevron-right"></i></button>
                                </div>
                            `;

                            // Toggle panel visibility based on screen size
                            const isMobile = window.innerWidth <= 768;
                            
                            if (isMobile) {
                                infoPanel.style.bottom = isCurrentlyOpen ? '-100%' : '0';
                            } else {
                                infoPanel.style.right = isCurrentlyOpen ? '-300px' : '0';
                            }
                            isInfoPanelOpen = !isCurrentlyOpen;
                        })
                        .addTo(map);

                    const label = L.marker(facility.coords, {
                        icon: L.divIcon({
                            className: 'map-label medical-label',
                            html: `<div>${facility.name}</div>`,
                            iconSize: [200, 20],
                            iconAnchor: [100, 0]
                        })
                    }).addTo(map);

                    medicalMarkers.push({
                        marker,
                        label
                    });
                });
                isMedicalVisible = true;
                button.classList.add('active');
            button.style.backgroundColor = '#FF4444';
            }
        }

        function toggleSchools() {
            const button = document.querySelector('button[onclick="toggleSchools()"]');
            if (isSchoolsVisible) {
                schoolMarkers.forEach(marker => {
                    marker.marker.remove();
                    marker.label.remove();
                });
                schoolMarkers = [];
                isSchoolsVisible = false;
                button.classList.remove('active');
            button.style.backgroundColor = '';
            } else {
                const schools = [{
                    name: 'Valenzuela National High School',
                    coords: [14.6830, 120.9805],
                    description: 'A comprehensive secondary education institution with modern facilities including a gymnasium that serves as an emergency shelter. Features multiple evacuation points, emergency response equipment, and trained safety personnel.'
                },{
                    name: 'Serrano Elementary School',
                    coords: [14.6870, 120.9845],
                    description: 'Primary education center with spacious grounds and covered courts that can be utilized during emergencies. Equipped with first aid stations and emergency communication systems.'
                },{
                    name: 'Marulas Central School',
                    coords: [14.67601337707112, 120.98498637949744],
                    description: 'Well-established elementary school with dedicated emergency assembly areas and disaster preparedness facilities. Regular conduct of emergency drills and safety training programs.'
                },{
                    name: 'Bitik Elementary School',
                    coords: [14.680180922064459, 120.98651613531823],
                    description: 'Community-focused elementary school with strategic location for emergency response. Features accessible evacuation routes and designated safe zones for various emergency scenarios.'
                }];

                schools.forEach(school => {
                    const marker = L.marker(school.coords)
                        .on('click', () => {
                            const infoPanel = document.getElementById('info-panel');
                            const isCurrentlyOpen = infoPanel.style.right === '0px';

                            document.getElementById('info-content').innerHTML = `
                                <h3>${school.name}</h3>
                                <p><strong>Location:</strong> ${school.coords[0].toFixed(4)}, ${school.coords[1].toFixed(4)}</p>
                                <p>${school.description}</p>
                            `;

                            // Toggle panel visibility based on screen size
                            const isMobile = window.innerWidth <= 768;
                            
                            if (isMobile) {
                                infoPanel.style.bottom = isCurrentlyOpen ? '-100%' : '0';
                            } else {
                                infoPanel.style.right = isCurrentlyOpen ? '-300px' : '0';
                            }
                            isInfoPanelOpen = !isCurrentlyOpen;
                        })
                        .addTo(map);

                    const label = L.marker(school.coords, {
                        icon: L.divIcon({
                            className: 'map-label school-label',
                            html: `<div>${school.name}</div>`,
                            iconSize: [200, 20],
                            iconAnchor: [100, 0]
                        })
                    }).addTo(map);

                    schoolMarkers.push({
                        marker,
                        label
                    });
                });
                isSchoolsVisible = true;
                button.classList.add('active');
            button.style.backgroundColor = '#FF4444';
            }
        }

        function toggleSportsVenues() {
            const button = document.querySelector('button[onclick="toggleSportsVenues()"]');
            if (isSportsVisible) {
                sportsMarkers.forEach(marker => {
                    marker.marker.remove();
                    marker.label.remove();
                });
                sportsMarkers = [];
                isSportsVisible = false;
                button.classList.remove('active');
            button.style.backgroundColor = '';
            } else {
                const venues = [{
                    name: 'THOA Wild Center',
                    coords: [14.682998859302277, 120.98803948610599],
                    description:''
                }, {
                    name: 'Manotoc Basketball Court',
                    coords: [14.68306, 120.97972],
                    description:''
                }, {
                    name: 'Elysian Court',
                    coords: [14.674347926774262, 120.97964155436341],
                    description:''
                }];

                venues.forEach(venue => {
                    const marker = L.marker(venue.coords)
                        .on('click', () => {
                            const infoPanel = document.getElementById('info-panel');
                            const isCurrentlyOpen = infoPanel.style.right === '0px';

                            document.getElementById('info-content').innerHTML = `
                                <h3>${venue.name}</h3>
                                <p><strong>Location:</strong> ${venue.coords[0].toFixed(4)}, ${venue.coords[1].toFixed(4)}</p>
                                <p>${venue.description}</p>
                            `;

                            // Toggle panel visibility based on screen size
                            const isMobile = window.innerWidth <= 768;
                            
                            if (isMobile) {
                                infoPanel.style.bottom = isCurrentlyOpen ? '-100%' : '0';
                            } else {
                                infoPanel.style.right = isCurrentlyOpen ? '-300px' : '0';
                            }
                            isInfoPanelOpen = !isCurrentlyOpen;
                        })
                        .addTo(map);

                    const label = L.marker(venue.coords, {
                        icon: L.divIcon({
                            className: 'map-label sports-label',
                            html: `<div>${venue.name}</div>`,
                            iconSize: [200, 20],
                            iconAnchor: [100, 0]
                        })
                    }).addTo(map);

                    sportsMarkers.push({
                        marker,
                        label
                    });
                });
                isSportsVisible = true;
                button.classList.add('active');
            button.style.backgroundColor = '#FF4444';
            }
        }

        function toggleCommunityCenters() {
            const button = document.querySelector('button[onclick="toggleCommunityCenters()"]');
            if (isCommunityVisible) {
                // Remove existing markers
                communityMarkers.forEach(marker => {
                    marker.marker.remove();
                    marker.label.remove();
                });
                communityMarkers = [];
                isCommunityVisible = false;
                button.classList.remove('active');
            button.style.backgroundColor = '';
            } else {
                // Community center locations
                const centers = [{
                    name: '3S Center Marulas',
                    coords: [14.674130969163468, 120.98293965436353],
                    description:''
                },{
                    name: 'MNDZ Evacuation Center',
                    coords: [14.6896373612385, 120.9862151419276],
                    description:''
                }];

                // Add markers
                centers.forEach(center => {
                    const marker = L.marker(center.coords)
                        .on('click', () => {
                            const infoPanel = document.getElementById('info-panel');
                            const isCurrentlyOpen = infoPanel.style.right === '0px';

                            document.getElementById('info-content').innerHTML = `
                                <h3>${center.name}</h3>
                                <p><strong>Location:</strong> ${center.coords[0].toFixed(4)}, ${center.coords[1].toFixed(4)}</p>
                                <p>${center.description}</p>
                            `;

                            // Toggle panel visibility based on screen size
                            const isMobile = window.innerWidth <= 768;
                            
                            if (isMobile) {
                                infoPanel.style.bottom = isCurrentlyOpen ? '-100%' : '0';
                            } else {
                                infoPanel.style.right = isCurrentlyOpen ? '-300px' : '0';
                            }
                            isInfoPanelOpen = !isCurrentlyOpen;
                        })
                        .addTo(map);

                    const label = L.marker(center.coords, {
                        icon: L.divIcon({
                            className: 'map-label community-label',
                            html: `<div>${center.name}</div>`,
                            iconSize: [150, 20],
                            iconAnchor: [75, 0]
                        })
                    }).addTo(map);

                    communityMarkers.push({
                        marker,
                        label
                    });
                });
                isCommunityVisible = true;
                button.classList.add('active');
            button.style.backgroundColor = '#FF4444';
            }
        }
        // Function to close the info panel
        function closeInfoPanel() {
            const infoPanel = document.getElementById('info-panel');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile) {
                infoPanel.style.bottom = '-100%';
            } else {
                infoPanel.style.right = '-300px';
            }
            isInfoPanelOpen = false;
        }

        document.addEventListener('DOMContentLoaded', function() {
            const dropdownToggle = document.querySelector('.dropdown-toggle');
            const dropdownContent = document.querySelector('.dropdown-content');
            const mobileMenu = document.getElementById('mobile-menu');
            const sidebar = document.getElementById('sidebar');
            
            // Mobile menu toggle functionality
            mobileMenu.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                mobileMenu.classList.toggle('active');
            });
            
            // Close sidebar when clicking outside
            document.addEventListener('click', function(event) {
                if (!sidebar.contains(event.target) && !mobileMenu.contains(event.target) && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mobileMenu.classList.remove('active');
                }
            });
            
            // Handle touch swipe to close sidebar
            let touchStartX = 0;
            let touchEndX = 0;
            
            sidebar.addEventListener('touchstart', function(event) {
                touchStartX = event.touches[0].clientX;
            });
            
            sidebar.addEventListener('touchend', function(event) {
                touchEndX = event.changedTouches[0].clientX;
                if (touchStartX > touchEndX && sidebar.classList.contains('active')) {
                    sidebar.classList.remove('active');
                    mobileMenu.classList.remove('active');
                }
            });

            // Dropdown functionality
            if (dropdownToggle && dropdownContent) {
                dropdownToggle.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    dropdownContent.classList.toggle('show');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!dropdownToggle.contains(e.target) && !dropdownContent.contains(e.target)) {
                        dropdownContent.classList.remove('show');
                    }
                });

                // Prevent dropdown from closing when clicking inside it
                dropdownContent.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }
            
            // Handle window resize to adjust info panel position
            window.addEventListener('resize', function() {
                if (isInfoPanelOpen) {
                    const infoPanel = document.getElementById('info-panel');
                    const isMobile = window.innerWidth <= 768;
                    
                    if (isMobile) {
                        infoPanel.style.right = '';
                        infoPanel.style.bottom = '0';
                    } else {
                        infoPanel.style.bottom = '';
                        infoPanel.style.right = '0';
                    }
                }
            });
        });
    </script>
</body>

</html>